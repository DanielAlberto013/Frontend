<div class="reportes-container">
  <!-- HEADER CON BOTÓN DE REGRESO -->
  <div class="header">
    <div class="header-content">
      <button class="btn-regresar" (click)="regresarAlDashboard()">
        <i class="fas fa-arrow-left"></i>
        Regresar al Dashboard
      </button>
      <div class="header-info">
        <h1>
          <i class="fas fa-chart-bar"></i>
          <span *ngIf="authService.isAdmin() || authService.isRevisor()">Reportes de Proyectos Aprobados</span>
          <span *ngIf="authService.isDocente()">Mis Documentos Finales</span>
        </h1>
        <p *ngIf="authService.isAdmin() || authService.isRevisor()">
          Lista completa de proyectos aprobados en el sistema
        </p>
        <p *ngIf="authService.isDocente()">
          Documentos finales de tus proyectos aprobados
        </p>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- ERROR -->
  <div *ngIf="error && !loading" class="error">
    <i class="fas fa-exclamation-triangle"></i>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarDatos()">Reintentar</button>
  </div>

  <!-- ✅ NUEVA SECCIÓN: DOCUMENTOS FINALES -->
  <div *ngIf="!loading && !error && documentosFinales.length > 0 && !documentoSeleccionado" class="documentos-section">
    <div class="section-header">
      <h2><i class="fas fa-file-contract"></i> Documentos Finales por Proyecto</h2>
      <p>Documentos oficiales por partida presupuestal</p>
    </div>

    <!-- Botones de exportación para documentos -->
    <div class="export-buttons mb-4">
      <button class="btn-excel" (click)="generarDocumentosFinalesExcel()">
        <i class="fas fa-file-excel"></i> Exportar Todos a Excel
      </button>
    </div>

    <!-- Lista de documentos finales -->
    <div class="documentos-grid">
      <div *ngFor="let documento of documentosFinales" class="documento-card">
        <div class="documento-header">
          <h3>{{ documento.nombreProyecto }}</h3>
          <span class="clave-proyecto">{{ documento.claveProyecto }}</span>
        </div>
        
        <div class="documento-info">
          <div class="info-item">
            <strong>Tipo de Fondo:</strong>
            <span [class]="documento.tipoFondo.toLowerCase()">{{ documento.tipoFondo }}</span>
          </div>
          <div class="info-item">
            <strong>Vigencia:</strong>
            <span>{{ documento.vigenciaProyecto }}</span>
          </div>
          <div class="info-item">
            <strong>Partidas:</strong>
            <span>{{ documento.partidas.length }}</span>
          </div>
          <div class="info-item">
            <strong>Monto Aprobado:</strong>
            <span class="monto">${{ documento.montoAprobado.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
          </div>
        </div>

        <div class="documento-actions">
          <button class="btn-ver" (click)="seleccionarDocumento(documento)">
            <i class="fas fa-eye"></i> Ver Detalles
          </button>
          <button class="btn-pdf" (click)="generarDocumentoFinalPDF(documento)">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
          <button class="btn-excel" (click)="generarDocumentoFinalExcel(documento)">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ NUEVA SECCIÓN: DETALLE DE DOCUMENTO FINAL -->
  <div *ngIf="documentoSeleccionado" class="documento-detalle">
    <div class="documento-header-detalle">
      <button class="btn-regresar" (click)="regresarAListaDocumentos()">
        <i class="fas fa-arrow-left"></i> Volver a Documentos
      </button>
      <h2>Documento Final - {{ documentoSeleccionado.nombreProyecto }}</h2>
      <div class="acciones-documento">
        <button class="btn-pdf" (click)="generarDocumentoFinalPDF(documentoSeleccionado!)">
          <i class="fas fa-file-pdf"></i> Descargar PDF
        </button>
        <button class="btn-excel" (click)="generarDocumentoFinalExcel(documentoSeleccionado!)">
          <i class="fas fa-file-excel"></i> Descargar Excel
        </button>
      </div>
    </div>

    <!-- Información del documento -->
    <div class="documento-info-detalle">
      <div class="info-grid">
        <div class="info-item">
          <strong>Tipo de Convocatoria:</strong>
          <span>{{ documentoSeleccionado.tipoConvocatoria }}</span>
        </div>
        <div class="info-item">
          <strong>Clave de Proyecto:</strong>
          <span>{{ documentoSeleccionado.claveProyecto }}</span>
        </div>
        <div class="info-item">
          <strong>Vigencia:</strong>
          <span>{{ documentoSeleccionado.vigenciaProyecto }}</span>
        </div>
        <div class="info-item">
          <strong>Tipo de Fondo:</strong>
          <span [class]="documentoSeleccionado.tipoFondo.toLowerCase()">{{ documentoSeleccionado.tipoFondo }}</span>
        </div>
      </div>
    </div>

    <!-- Partidas del documento -->
    <div *ngFor="let partida of documentoSeleccionado.partidas" class="partida-detalle">
      <div class="partida-header">
        <h3>Partida {{ partida.partidaCodigo }} - {{ partida.partidaNombre }}</h3>
        <span class="monto-autorizado">Monto Autorizado: ${{ partida.montoAutorizado.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
      </div>
      
      <div class="partida-descripcion">
        <p>{{ partida.partidaDescripcion }}</p>
      </div>

      <!-- Tabla de productos -->
      <div class="productos-table">
        <table>
          <thead>
            <tr>
              <th width="10%">No.</th>
              <th width="10%">Cantidad</th>
              <th width="50%">Descripción de Productos</th>
              <th width="15%">Precio Unitario</th>
              <th width="15%">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of partida.productos; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ producto.cantidad }}</td>
              <td>{{ producto.descripcion }}</td>
              <td>${{ producto.precioUnitario.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</td>
              <td>${{ producto.total.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3"></td>
              <td><strong>Subtotal</strong></td>
              <td><strong>${{ partida.subtotal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</strong></td>
            </tr>
            <tr>
              <td colspan="3"></td>
              <td><strong>IVA 16%</strong></td>
              <td><strong>${{ partida.iva.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</strong></td>
            </tr>
            <tr>
              <td colspan="3"></td>
              <td><strong>Total</strong></td>
              <td><strong>${{ partida.total.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Totales generales y firmas -->
    <div class="documento-totales">
      <div class="totales-grid">
        <div class="total-item">
          <strong>Subtotal General:</strong>
          <span>${{ documentoSeleccionado.subtotal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
        </div>
        <div class="total-item">
          <strong>IVA General:</strong>
          <span>${{ documentoSeleccionado.iva.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
        </div>
        <div class="total-item">
          <strong>Total General:</strong>
          <span>${{ documentoSeleccionado.total.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
        </div>
        <div class="total-item">
          <strong>Monto Aprobado:</strong>
          <span>${{ documentoSeleccionado.montoAprobado.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
        </div>
      </div>

      <div class="firmas-section">
        <div class="firma">
          <div class="linea-firma"></div>
          <p><strong>{{ documentoSeleccionado.docenteNombre }}</strong></p>
          <p>LÍDER DE PROYECTO</p>
        </div>
        <div class="firma">
          <div class="linea-firma"></div>
          <p><strong>SUBDIRECTOR ACADEMICO DEL ITESCAM</strong></p>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PARA ADMIN/REVISOR -->
  <div *ngIf="(authService.isAdmin() || authService.isRevisor()) && !loading && !error && !documentoSeleccionado && documentosFinales.length === 0" class="admin-content">
    
    <!-- BOTONES DE EXPORTACIÓN -->
    <div class="export-buttons">
      <button class="btn-excel" (click)="generarReporteExcel()" [disabled]="proyectosUnicos.length === 0">
        <i class="fas fa-file-excel"></i> Exportar a Excel
      </button>
      <button class="btn-pdf" (click)="generarReportePDF()" [disabled]="proyectosUnicos.length === 0">
        <i class="fas fa-file-pdf"></i> Exportar a PDF
      </button>
      <button class="btn-regresar-inline" (click)="regresarAlDashboard()">
        <i class="fas fa-home"></i> Dashboard
      </button>
    </div>

    <!-- RESUMEN GENERAL -->
    <div class="resumen-general">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-folder-open"></i>
        </div>
        <div class="stat-info">
          <h3>{{ proyectosUnicos.length }}</h3>
          <p>Proyectos Aprobados</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-info">
          <h3>${{ getTotalGeneral().toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</h3>
          <p>Presupuesto Total</p>
        </div>
      </div>
    </div>

    <!-- LISTA DIRECTA DE PROYECTOS -->
    <div class="proyectos-lista">
      <div *ngFor="let proyecto of proyectosUnicos" class="proyecto-card-directo">
        <div class="proyecto-header-directo">
          <h3>{{ proyecto.proyectoNombre }}</h3>
          <span class="estado-badge aprobado">Aprobado</span>
        </div>
        
        <div class="proyecto-info-directo">
          <div class="info-grid">
            <div class="info-item">
              <strong>Docente:</strong>
              <span>{{ proyecto.docenteNombre }}</span>
            </div>
            <div class="info-item">
              <strong>Partida:</strong>
              <span>{{ proyecto.partidaCodigo }} - {{ proyecto.partidaNombre }}</span>
            </div>
            <div class="info-item">
              <strong>Presupuesto Total:</strong>
              <span class="monto">${{ proyecto.presupuestoTotal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
            </div>
            <div class="info-item">
              <strong>Federal:</strong>
              <span class="monto">${{ proyecto.presupuestoFederal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
            </div>
            <div class="info-item">
              <strong>Estatal:</strong>
              <span class="monto">${{ proyecto.presupuestoEstatal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
            </div>
          </div>
        </div>
        
        <div class="proyecto-status-directo">
          <i class="fas fa-check-circle"></i>
          <span>Listo para realizar cotizaciones</span>
        </div>
      </div>

      <!-- SIN DATOS -->
      <div *ngIf="proyectosUnicos.length === 0" class="no-data">
        <i class="fas fa-inbox"></i>
        <h3>No hay proyectos aprobados</h3>
        <p>No se encontraron proyectos con estado APROBADO en el sistema</p>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PARA DOCENTE -->
  <div *ngIf="authService.isDocente() && !loading && !error && !documentoSeleccionado && documentosFinales.length === 0" class="docente-content">
    
    <!-- BOTONES DEL DOCUMENTO FINAL -->
    <div class="documento-actions" *ngIf="documentoFinalDocente">
      <button class="btn-pdf" (click)="generarDocumentoDocentePDF()" [disabled]="documentoFinalDocente.proyectos.length === 0">
        <i class="fas fa-file-pdf"></i> Descargar PDF
      </button>
      <button class="btn-excel" (click)="generarDocumentoDocenteExcel()" [disabled]="documentoFinalDocente.proyectos.length === 0">
        <i class="fas fa-file-excel"></i> Descargar Excel
      </button>
      <button class="btn-print" (click)="imprimirDocumento()" [disabled]="documentoFinalDocente.proyectos.length === 0">
        <i class="fas fa-print"></i> Imprimir
      </button>
      <button class="btn-regresar-inline" (click)="regresarAlDashboard()">
        <i class="fas fa-home"></i> Dashboard
      </button>
    </div>

    <!-- DOCUMENTO FINAL DEL DOCENTE -->
    <div *ngIf="documentoFinalDocente" class="documento-container">
      <div class="documento-header">
        <div class="documento-logo">
          <i class="fas fa-file-contract"></i>
        </div>
        <div class="documento-info">
          <h2>Mis Documentos Finales</h2>
          <p>ITESCAM - Sistema de Finanzas</p>
        </div>
      </div>

      <div class="documento-body">
        <!-- INFORMACIÓN DEL DOCENTE -->
        <div class="docente-info">
          <h3>{{ documentoFinalDocente.docenteNombre }}</h3>
          <p>Fecha de generación: {{ documentoFinalDocente.fechaGeneracion | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>

        <!-- PROYECTOS APROBADOS -->
        <div *ngIf="documentoFinalDocente.proyectos.length > 0" class="proyectos-documento">
          <div *ngFor="let proyecto of documentoFinalDocente.proyectos" class="proyecto-documento">
            <div class="proyecto-header">
              <h4>{{ proyecto.nombre }}</h4>
              <span class="total">${{ proyecto.presupuestoTotal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</span>
            </div>
            
            <div class="proyecto-detalles">
              <p><strong>Descripción:</strong> {{ proyecto.descripcion }}</p>
              <p><strong>Edición:</strong> {{ proyecto.edicion }}</p>
              <p><strong>Presupuesto Federal:</strong> ${{ proyecto.presupuestoFederal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</p>
              <p><strong>Presupuesto Estatal:</strong> ${{ proyecto.presupuestoEstatal.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</p>
            </div>
          </div>
        </div>

        <!-- TOTAL GENERAL -->
        <div class="documento-total">
          <h3>Presupuesto Total Aprobado: ${{ documentoFinalDocente.totalGeneral.toLocaleString('es-MX', { minimumFractionDigits: 2 }) }}</h3>
        </div>

        <!-- SIN PROYECTOS -->
        <div *ngIf="documentoFinalDocente.proyectos.length === 0" class="no-proyectos">
          <i class="fas fa-folder-open"></i>
          <h4>No tienes proyectos aprobados</h4>
          <p>Los documentos finales aparecerán aquí una vez que tus proyectos y cotizaciones sean aprobados</p>
        </div>
      </div>

      <div class="documento-footer">
        <p>ITESCAM - Sistema de Gestión de Finanzas</p>
        <small>Este documento lista tus proyectos aprobados para gestión de recursos</small>
      </div>
    </div>
  </div>

  <!-- MENSAJE CUANDO NO HAY DOCUMENTOS FINALES -->
  <div *ngIf="!loading && !error && documentosFinales.length === 0 && !documentoSeleccionado && (!documentoFinalDocente || documentoFinalDocente.proyectos.length === 0)" class="no-documentos">
    <div class="no-data">
      <i class="fas fa-file-contract"></i>
      <h3>No hay documentos finales disponibles</h3>
      <p>Los documentos finales aparecerán aquí una vez que tus proyectos y cotizaciones sean aprobados</p>
      <div class="no-documentos-actions">
        <button class="btn-regresar-inline" (click)="regresarAlDashboard()">
          <i class="fas fa-home"></i> Volver al Dashboard
        </button>
      </div>
    </div>
  </div>
</div>